<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>yaodaoTV 播放器</title>


    <!-- Favicon -->
    <link rel="icon" href="https://images.icon-icons.com/38/PNG/512/retrotv_5520.png">
    <link rel="apple-touch-icon" href="https://images.icon-icons.com/38/PNG/512/retrotv_5520.png">
    <link rel="manifest" href="manifest.json">

    <script src="libs/tailwindcss.min.js"></script>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #0f1622;
            color: white;
        }
        .player-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }
        #player {
            width: 100%;
            height: 60vh; /* 视频播放器高度 */
        }
        .loading-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            z-index: 100;
            flex-direction: column;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .error-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            z-index: 100;
            flex-direction: column;
            text-align: center;
            padding: 1rem;
        }
        .error-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        .episode-active {
            background-color: #3b82f6 !important;
            border-color: #60a5fa !important;
        }
        .episode-grid {
            max-height: 30vh;
            overflow-y: auto;
            padding: 1rem 0;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 46px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #00ccff;
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }
        /* 添加快捷键提示样式 */
        .shortcut-hint {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .shortcut-hint.show {
            opacity: 1;
        }

        /* 原生全屏时，播放器容器铺满 */
        .player-container:-webkit-full-screen,
        .player-container:fullscreen {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 10000;
            background-color: #000;
        }
        .player-container:-webkit-full-screen #player,
        .player-container:fullscreen #player {
            width: 100%; height: 100%;
        }
        
        /* 横屏按钮样式 */
        .rotate-screen-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background-color: rgba(0, 0, 0, 0.6);
            border: none;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            transition: background-color 0.3s;
        }
        
        .rotate-screen-btn:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        
        .rotate-screen-btn svg {
            width: 24px;
            height: 24px;
        }
        
        /* 横屏模式样式 */
        .landscape-mode {
            position: fixed !important;
            top: 0;
            left: 0;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999;
            background-color: #000;
            transform: rotate(90deg);
            transform-origin: bottom left;
            overflow: hidden;
        }
        
        .landscape-mode #player {
            width: 100vh !important;
            height: 100vw !important;
            transform: translateY(-100vw);
            transform-origin: top left;
        }
        
        /* 退出横屏按钮 */
        .exit-landscape-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background-color: rgba(0, 0, 0, 0.6);
            border: none;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10000;
            transition: background-color 0.3s;
        }
    </style>
</head>
<body>
    <header class="bg-[#111] p-4 flex items-center border-b border-[#333] gap-2 player-header">
        <div class="flex items-center min-w-0">
            <a href="/" class="flex items-center min-w-0">
                <svg class="w-8 h-8 mr-2 text-[#00ccff] logo-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
                <h1 class="text-xl font-bold gradient-text logo-text">yaodaoTV</h1>
            </a>
        </div>
        <h2 id="videoTitle" class="text-xl font-semibold flex-1 text-center overflow-x-auto whitespace-nowrap truncate custom-title-scroll"></h2>
        <a href="/" class="px-4 py-2 bg-[#222] hover:bg-[#333] border border-[#333] rounded-lg transition-colors flex items-center min-w-0 home-btn">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 21V9.5l-7-5-7 5V21a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2z" />
              <path d="M9 22V12h6v10" />
            </svg>
            <span class="home-btn-text">返回首页</span>
        </a>
    </header>

    <!-- 密码验证弹窗 -->
    <div id="passwordModal" class="fixed inset-0 bg-black/95 hidden items-center justify-center z-[65] transition-opacity duration-300">
        <div class="bg-[#111] p-8 rounded-lg w-11/12 max-w-md border border-[#333] max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-6 flex-none">
                <h2 class="text-2xl font-bold gradient-text">访问验证</h2>
            </div>
            <div class="mb-6">
                <p class="text-gray-300 mb-4">请输入密码继续访问</p>
                <form id="passwordForm" onsubmit="handlePasswordSubmit(); return false;">
                    <input type="text" name="username" id="username" autocomplete="username" style="display:none" tabindex="-1" aria-hidden="true">
                    <input type="password" id="passwordInput" class="w-full bg-[#111] border border-[#333] text-white px-4 py-3 rounded-lg focus:outline-none focus:border-white transition-colors" placeholder="密码..." autocomplete="new-password">
                    <button id="passwordSubmitBtn" type="submit" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">提交</button>
                </form>
                <p id="passwordError" class="text-red-500 mt-2 hidden">密码错误，请重试</p>
            </div>
        </div>
    </div>

    <main class="container mx-auto px-4 py-4">
        <!-- 视频播放区 -->
        <div id="playerContainer" class="player-container">
            <div class="relative">
                <div id="player"></div>
                <div class="loading-container" id="loading">
                    <div class="loading-spinner"></div>
                    <div>正在加载视频...</div>
                </div>
                <div class="error-container" id="error">
                    <div class="error-icon">⚠️</div>
                    <div id="error-message">视频加载失败</div>
                    <div style="margin-top: 10px; font-size: 14px; color: #aaa;">请尝试其他视频源或稍后重试</div>
                </div>
                
                <!-- 添加横屏按钮 -->
                <button id="rotateScreenBtn" class="rotate-screen-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"></path>
                        <path d="m15 15-5-5"></path>
                        <path d="M21 3v4"></path>
                        <path d="M17 3h4"></path>
                        <path d="M15 9h-3a2 2 0 0 0-2 2v3"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- 集数导航 -->
        <div class="player-container">
            <div class="flex justify-between items-center my-4">
                <button onclick="playPreviousEpisode()" id="prevButton" class="px-4 py-2 bg-[#222] hover:bg-[#333] border border-[#333] rounded-lg transition-colors">
                    <svg class="w-5 h-5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    上一集
                </button>
                <span class="text-gray-400" id="episodeInfo">加载中...</span>
                <button onclick="playNextEpisode()" id="nextButton" class="px-4 py-2 bg-[#222] hover:bg-[#333] border border-[#333] rounded-lg transition-colors">
                    下一集
                    <svg class="w-5 h-5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- 添加自动播放开关和排序按钮 -->
        <div class="player-container">
            <div class="flex justify-end items-center mb-4 gap-2">
                <span class="text-gray-400 text-sm">自动连播</span>
                <label class="switch">
                    <input type="checkbox" id="autoplayToggle">
                    <span class="slider"></span>
                </label>
                <button onclick="toggleEpisodeOrder()" class="ml-4 px-4 py-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 text-white font-semibold rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" id="orderIcon" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd" />
                    </svg>
                    <span id="orderText">倒序排列</span>
                </button>
                <button id="lockToggle" onclick="toggleControlsLock()" title="锁定控制" 
                        class="px-2 py-1 bg-[#333] hover:bg-[#444] text-white rounded-full transition">
                    <svg id="lockIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <!-- 默认状态：未锁图标 -->
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M15 11V7a3 3 0 00-6 0v4m-3 4h12v6H6v-6z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- 集数网格 -->
        <div class="player-container">
            <div class="episode-grid" id="episodesGrid">
                <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2" id="episodesList">
                    <!-- 集数将在这里动态加载 -->
                    <div class="col-span-full text-center text-gray-400 py-8">加载中...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- 添加快捷键提示元素 -->
    <div class="shortcut-hint" id="shortcutHint">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="shortcutIcon">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        <span id="shortcutText"></span>
    </div>
    
    <!-- 添加退出横屏按钮 -->
    <button id="exitLandscapeBtn" class="exit-landscape-btn" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 6L6 18"></path>
            <path d="M6 6l12 12"></path>
        </svg>
    </button>

    <!-- 引入纯 JS sha256（HTTP 下依然可用） -->
    <script src="libs/sha256.min.js"></script>
    <script>
        // 保存原始 js‑sha256 实现，避免被 password.js 覆盖
        window._jsSha256 = window.sha256;
    </script>
    
    <script src="libs/hls.min.js" crossorigin="anonymous"></script>
    <script src="libs/DPlayer.min.js" crossorigin="anonymous"></script>

    <script src="js/config.js"></script>
    <script src="js/password.js"></script>

    <script>
        // 创建全局环境变量对象
        window.__ENV__ = window.__ENV__ || {};
        
        // 注入服务器端环境变量 (将由服务器端替换)
        // PASSWORD 变量将在这里被服务器端注入
        window.__ENV__.PASSWORD = "{{PASSWORD}}";

        // =================================
        // ============== PLAYER ==========
        // =================================
        // 全局变量
        let currentVideoTitle = '';
        let currentEpisodeIndex = 0;
        let currentEpisodes = [];
        let episodesReversed = false;
        let dp = null;
        let currentHls = null; // 跟踪当前HLS实例
        let autoplayEnabled = true; // 默认开启自动连播
        let isUserSeeking = false; // 跟踪用户是否正在拖动进度条
        let videoHasEnded = false; // 跟踪视频是否已经自然结束
        let userClickedPosition = null; // 记录用户点击的位置
        let shortcutHintTimeout = null; // 用于控制快捷键提示显示时间
        let adFilteringEnabled = true; // 默认开启广告过滤
        let progressSaveInterval = null; // 定期保存进度的计时器
        let isLandscape = false; // 跟踪是否处于横屏模式

        // 页面加载
        document.addEventListener('DOMContentLoaded', function() {
            // 先检查用户是否已通过密码验证
            if (!isPasswordVerified()) {
                // 隐藏加载提示
                document.getElementById('loading').style.display = 'none';
                return;
            }

            initializePageContent();
            
            // 初始化横屏按钮功能
            setupLandscapeMode();
        });

        // 监听密码验证成功事件
        document.addEventListener('passwordVerified', () => {
            document.getElementById('loading').style.display = 'block';

            initializePageContent();
            
            // 初始化横屏按钮功能
            setupLandscapeMode();
        });
        
        // 设置横屏模式功能
        function setupLandscapeMode() {
            // 初始化变量
            const playerContainer = document.getElementById('playerContainer');
            const rotateBtn = document.getElementById('rotateScreenBtn');
            const exitBtn = document.getElementById('exitLandscapeBtn');
            
            // 横屏按钮点击处理
            if (rotateBtn) {
                rotateBtn.addEventListener('click', function() {
                    enterLandscapeMode();
                });
            }
            
            // 退出横屏按钮点击处理
            if (exitBtn) {
                exitBtn.addEventListener('click', function() {
                    exitLandscapeMode();
                });
            }
            
            // 监听全屏变化事件
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
            
            // 监听方向变化事件（部分设备支持）
            window.addEventListener('orientationchange', function() {
                // 如果设备已经是横屏，且我们处于模拟横屏模式，则退出模拟
                if ((window.orientation === 90 || window.orientation === -90) && isLandscape) {
                    exitLandscapeMode();
                }
            });
        }
        
        // 进入横屏模式
        function enterLandscapeMode() {
            if (!isLandscape) {
                isLandscape = true;
                
                const playerContainer = document.getElementById('playerContainer');
                const rotateBtn = document.getElementById('rotateScreenBtn');
                const exitBtn = document.getElementById('exitLandscapeBtn');
                
                // 保存当前滚动位置
                const scrollPos = window.scrollY;
                
                // 添加横屏类
                playerContainer.classList.add('landscape-mode');
                
                // 显示退出按钮
                exitBtn.style.display = 'flex';
                
                // 隐藏横屏按钮
                if (rotateBtn) rotateBtn.style.display = 'none';
                
                // 尝试请求全屏
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                }
                
                // 锁定滚动
                document.body.style.overflow = 'hidden';
                
                // 尝试锁定屏幕方向（仅支持部分浏览器）
                if (screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock('landscape').catch(function(error) {
                        console.log('无法锁定屏幕方向: ', error);
                    });
                }
                
                // 如果有DPlayer实例，尝试调整视频大小
                if (typeof dp !== 'undefined') {
                    dp.notice('已进入横屏模式', 3000);
                    // 触发窗口调整事件，让播放器重新计算尺寸
                    setTimeout(function() {
                        window.dispatchEvent(new Event('resize'));
                    }, 300);
                }
                
                console.log('进入横屏模式');
            }
        }
        
        // 退出横屏模式
        function exitLandscapeMode() {
            if (isLandscape) {
                isLandscape = false;
                
                const playerContainer = document.getElementById('playerContainer');
                const rotateBtn = document.getElementById('rotateScreenBtn');
                const exitBtn = document.getElementById('exitLandscapeBtn');
                
                // 移除横屏类
                playerContainer.classList.remove('landscape-mode');
                
                // 隐藏退出按钮
                exitBtn.style.display = 'none';
                
                // 显示横屏按钮
                if (rotateBtn) rotateBtn.style.display = 'flex';
                
                // 退出全屏
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
                
                // 恢复滚动
                document.body.style.overflow = '';
                
                // 解锁屏幕方向
                if (screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock();
                }
                
                // 如果有DPlayer实例，尝试调整视频大小
                if (typeof dp !== 'undefined') {
                    dp.notice('已退出横屏模式', 3000);
                    // 触发窗口调整事件，让播放器重新计算尺寸
                    setTimeout(function() {
                        window.dispatchEvent(new Event('resize'));
                    }, 300);
                }
                
                console.log('退出横屏模式');
            }
        }
        
        // 处理全屏变化事件
        function handleFullscreenChange() {
            // 如果退出了全屏但仍处于横屏模式，则退出横屏模式
            if (!document.fullscreenElement && !document.webkitFullscreenElement && isLandscape) {
                exitLandscapeMode();
            }
        }

        // 初始化页面内容
        function initializePageContent() {
            // 解析URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const videoUrl = urlParams.get('url');
            const title = urlParams.get('title');
            const sourceCode = urlParams.get('source_code');
            let index = parseInt(urlParams.get('index') || '0');
            const episodesList = urlParams.get('episodes'); // 新增：从URL获取集数信息

            // 从localStorage获取数据
            currentVideoTitle = title || localStorage.getItem('currentVideoTitle') || '未知视频';
            currentEpisodeIndex = index;
            
            // 设置自动连播开关状态
            autoplayEnabled = localStorage.getItem('autoplayEnabled') !== 'false'; // 默认为true
            document.getElementById('autoplayToggle').checked = autoplayEnabled;
            
            // 获取广告过滤设置
            adFilteringEnabled = localStorage.getItem(PLAYER_CONFIG.adFilteringStorage) !== 'false'; // 默认为true
            
            // 监听自动连播开关变化
            document.getElementById('autoplayToggle').addEventListener('change', function(e) {
                autoplayEnabled = e.target.checked;
                localStorage.setItem('autoplayEnabled', autoplayEnabled);
            });
            
            // 优先使用URL传递的集数信息，否则从localStorage获取
            try {
                if (episodesList) {
                    // 如果URL中有集数数据，优先使用它
                    currentEpisodes = JSON.parse(decodeURIComponent(episodesList));
                    console.log('从URL恢复集数信息:', currentEpisodes.length);
                } else {
                    // 否则从localStorage获取
                    currentEpisodes = JSON.parse(localStorage.getItem('currentEpisodes') || '[]');
                    console.log('从localStorage恢复集数信息:', currentEpisodes.length);
                }
                
                // 检查集数索引是否有效，如果无效则调整为0
                if (index < 0 || (currentEpisodes.length > 0 && index >= currentEpisodes.length)) {
                    console.warn(`无效的剧集索引 ${index}，调整为范围内的值`);
                    
                    // 如果索引太大，则使用最大有效索引
                    if (index >= currentEpisodes.length && currentEpisodes.length > 0) {
                        index = currentEpisodes.length - 1;
                    } else {
                        index = 0;
                    }
                    currentEpisodeIndex = index;
                }
                
                // 从localStorage获取排序设置
                episodesReversed = localStorage.getItem('episodesReversed') === 'true';
                updateOrderButton();
                
            } catch (e) {
                console.error('恢复集数信息失败:', e);
                currentEpisodes = [];
            }
            
            // 设置标题
            document.title = currentVideoTitle + ' - yaodaoTV 播放器';
            document.getElementById('videoTitle').textContent = currentVideoTitle;
            
            // 更新集数信息
            updateEpisodeInfo();
            
            // 渲染集数列表
            renderEpisodes();
            
            // 更新按钮状态
            updateButtonStates();
            
            // 如果有视频URL，初始化播放器
            if (videoUrl) {
                initPlayer(videoUrl, sourceCode);
            } else if (currentEpisodes.length > 0) {
                // 如果没有视频URL但有集数信息，播放当前集
                playEpisode(currentEpisodeIndex);
            } else {
                // 如果既没有视频URL也没有集数信息，显示错误
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'flex';
                document.getElementById('error-message').textContent = '无法加载视频，请返回首页重新选择';
            }
        }

        // 初始化播放器
        function initPlayer(url, sourceCode) {
            // 首先隐藏之前可能显示的错误
            document.getElementById('error').style.display = 'none';
            // 显示加载指示器
            document.getElementById('loading').style.display = 'flex';
            
            // 如果已经有播放器实例，先销毁它
            if (dp) {
                try {
                    // 销毁之前的HLS实例
                    if (currentHls) {
                        currentHls.destroy();
                        currentHls = null;
                    }
                    
                    dp.destroy();
                    dp = null;
                } catch (e) {
                    console.error('销毁播放器失败:', e);
                }
            }
            
            // 清除进度保存计时器
            if (progressSaveInterval) {
                clearInterval(progressSaveInterval);
                progressSaveInterval = null;
            }
            
            // 重置视频结束标志
            videoHasEnded = false;
            
            // 创建播放器配置
            const options = {
                container: document.getElementById('player'),
                video: {
                    url: url,
                    type: 'hls',
                    customType: {
                        hls: function (video, player) {
                            const hls = new Hls({
                                // HLS配置
                                debug: false,
                                // 启用低延迟HLS
                                lowLatencyMode: true,
                                // 减少初始缓冲时间
                                maxBufferLength: 10,
                                maxMaxBufferLength: 30,
                                // 设置分段加载超时
                                fragLoadingTimeOut: 20000,
                                manifestLoadingTimeOut: 20000,
                                // 设置重试次数
                                fragLoadingMaxRetry: 6,
                                manifestLoadingMaxRetry: 6,
                                // 设置重试间隔
                                fragLoadingRetryDelay: 500,
                                manifestLoadingRetryDelay: 500,
                                // 设置ABR策略
                                abrEwmaDefaultEstimate: 500000,
                                // 设置自动级别切换
                                startLevel: -1,
                                // 设置初始缓冲目标
                                maxBufferHole: 0.5,
                                highBufferWatchdogPeriod: 2,
                                // 设置错误处理
                                maxStarvationDelay: 4,
                                // 设置实时流配置
                                liveSyncDurationCount: 3,
                                liveMaxLatencyDurationCount: 10,
                                // 设置字幕处理
                                enableWebVTT: true,
                                enableCEA708Captions: true,
                            });
                            
                            // 保存HLS实例以便后续销毁
                            currentHls = hls;
                            
                            // 监听HLS错误
                            hls.on(Hls.Events.ERROR, function (event, data) {
                                if (data.fatal) {
                                    switch(data.type) {
                                        case Hls.ErrorTypes.NETWORK_ERROR:
                                            console.error('HLS网络错误:', data);
                                            // 尝试恢复
                                            hls.startLoad();
                                            break;
                                        case Hls.ErrorTypes.MEDIA_ERROR:
                                            console.error('HLS媒体错误:', data);
                                            // 尝试恢复
                                            hls.recoverMediaError();
                                            break;
                                        default:
                                            console.error('HLS致命错误:', data);
                                            // 显示错误信息
                                            document.getElementById('loading').style.display = 'none';
                                            document.getElementById('error').style.display = 'flex';
                                            document.getElementById('error-message').textContent = '视频加载失败: ' + data.details;
                                            break;
                                    }
                                } else {
                                    console.warn('HLS非致命错误:', data);
                                }
                            });
                            
                            // 加载视频
                            hls.loadSource(url);
                            hls.attachMedia(video);
                            
                            // 监听清单加载完成事件
                            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                                // 隐藏加载指示器
                                document.getElementById('loading').style.display = 'none';
                                
                                // 尝试自动播放
                                const playPromise = video.play();
                                if (playPromise !== undefined) {
                                    playPromise.catch(error => {
                                        console.warn('自动播放失败:', error);
                                        // 显示播放按钮提示用户手动点击播放
                                        player.notice('点击播放按钮开始播放', 3000);
                                    });
                                }
                            });
                            
                            // 监听清单加载失败事件
                            hls.on(Hls.Events.MANIFEST_LOADING_ERROR, function(event, data) {
                                console.error('清单加载失败:', data);
                                document.getElementById('loading').style.display = 'none';
                                document.getElementById('error').style.display = 'flex';
                                document.getElementById('error-message').textContent = '视频源加载失败，请尝试其他视频源';
                            });
                            
                            // 监听分段加载超时事件
                            hls.on(Hls.Events.FRAG_LOAD_TIMEOUT, function(event, data) {
                                console.warn('分段加载超时:', data);
                                // 显示提示但不中断播放
                                player.notice('视频加载缓慢，请耐心等待', 3000);
                            });
                        }
                    }
                },
                autoplay: true,
                theme: '#00ccff',
                lang: 'zh-cn',
                hotkey: true,
                preload: 'auto',
                volume: 0.7,
                playbackSpeed: [0.5, 0.75, 1, 1.25, 1.5, 2],
                contextmenu: [
                    {
                        text: '访问 yaodaoTV',
                        link: '/'
                    }
                ]
            };
            
            // 创建播放器实例
            dp = new DPlayer(options);
            
            // 监听播放器事件
            setupPlayerEvents();
            
            // 尝试恢复播放进度
            tryRestorePlaybackPosition();
            
            // 设置进度条精确点击
            setTimeout(setupProgressBarPreciseClicks, 1000);
            
            // 设置移动端长按两倍速播放
            setTimeout(setupLongPressSpeedControl, 1000);
            
            // 开始定期保存播放进度
            startProgressSaveInterval();
        }

        // 设置播放器事件监听
        function setupPlayerEvents() {
            if (!dp) return;
            
            // 监听播放开始
            dp.on('play', function() {
                // 隐藏加载指示器
                document.getElementById('loading').style.display = 'none';
            });
            
            // 监听播放错误
            dp.on('error', function() {
                console.error('播放器错误');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'flex';
                document.getElementById('error-message').textContent = '视频播放出错，请尝试其他视频源';
            });
            
            // 监听视频结束
            dp.on('ended', function() {
                console.log('视频播放结束');
                videoHasEnded = true;
                
                // 保存当前进度
                saveCurrentProgress();
                
                // 如果启用了自动连播且有下一集，播放下一集
                if (autoplayEnabled && currentEpisodeIndex < currentEpisodes.length - 1) {
                    console.log('自动播放下一集');
                    setTimeout(function() {
                        playNextEpisode();
                    }, 1500);
                }
            });
            
            // 监听视频加载中
            dp.on('waiting', function() {
                console.log('视频加载中...');
            });
            
            // 监听视频可以播放
            dp.on('canplay', function() {
                console.log('视频可以播放');
                document.getElementById('loading').style.display = 'none';
            });
            
            // 监听进度条拖动开始
            dp.on('seeking', function() {
                isUserSeeking = true;
            });
            
            // 监听进度条拖动结束
            dp.on('seeked', function() {
                isUserSeeking = false;
                
                // 如果用户点击了进度条的特定位置，恢复到该位置
                if (userClickedPosition !== null) {
                    // 检查当前时间是否接近视频结尾
                    const currentTime = dp.video.currentTime;
                    const duration = dp.video.duration;
                    
                    // 如果当前时间接近结尾但用户点击的不是结尾位置
                    if (duration - currentTime < 0.5 && Math.abs(userClickedPosition - currentTime) > 1) {
                        console.log(`检测到意外跳转到结尾，恢复到用户点击位置: ${userClickedPosition.toFixed(2)}`);
                        dp.seek(userClickedPosition);
                    }
                    
                    // 清除用户点击位置记录
                    userClickedPosition = null;
                }
            });
            
            // 监听全屏变化
            dp.on('fullscreen', function() {
                console.log('进入全屏');
            });
            
            // 监听退出全屏
            dp.on('fullscreen_cancel', function() {
                console.log('退出全屏');
            });
            
            // 监听播放速度变化
            dp.on('ratechange', function() {
                const rate = dp.video.playbackRate;
                console.log(`播放速度变更为: ${rate}x`);
            });
        }

        // 尝试恢复播放进度
        function tryRestorePlaybackPosition() {
            if (!dp || !dp.video) return;
            
            // 获取视频ID
            const videoId = getVideoId();
            
            // 从localStorage获取保存的进度
            try {
                const progressKey = `videoProgress_${videoId}`;
                const progressRaw = localStorage.getItem(progressKey);
                
                if (progressRaw) {
                    const progress = JSON.parse(progressRaw);
                    const savedPosition = progress.position;
                    const duration = progress.duration;
                    const timestamp = progress.timestamp;
                    
                    // 检查保存的进度是否有效
                    if (savedPosition && savedPosition > 10 && savedPosition < duration - 10) {
                        // 检查时间戳是否在7天内
                        const now = Date.now();
                        const daysPassed = (now - timestamp) / (1000 * 60 * 60 * 24);
                        
                        if (daysPassed <= 7) {
                            // 等待视频元数据加载完成
                            dp.on('loadedmetadata', function() {
                                // 设置播放位置
                                dp.seek(savedPosition);
                                
                                // 显示恢复位置提示
                                showPositionRestoreHint(savedPosition);
                                
                                console.log(`恢复播放进度: ${savedPosition.toFixed(2)}/${duration.toFixed(2)}`);
                            });
                        } else {
                            console.log('保存的进度已过期（超过7天）');
                        }
                    } else {
                        console.log('保存的进度无效或接近视频开头/结尾');
                    }
                } else {
                    console.log('没有找到保存的播放进度');
                }
            } catch (e) {
                console.error('恢复播放进度失败:', e);
            }
        }

        // 获取当前视频的唯一ID
        function getVideoId() {
            return `${currentVideoTitle}_ep${currentEpisodeIndex}`;
        }

        // 更新集数信息显示
        function updateEpisodeInfo() {
            const episodeInfo = document.getElementById('episodeInfo');
            if (currentEpisodes.length > 0) {
                episodeInfo.textContent = `第 ${currentEpisodeIndex + 1} / ${currentEpisodes.length} 集`;
            } else {
                episodeInfo.textContent = '单集播放';
            }
        }

        // 更新上一集/下一集按钮状态
        function updateButtonStates() {
            const prevButton = document.getElementById('prevButton');
            const nextButton = document.getElementById('nextButton');
            
            // 如果是第一集，禁用上一集按钮
            if (currentEpisodeIndex <= 0) {
                prevButton.disabled = true;
                prevButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                prevButton.disabled = false;
                prevButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            // 如果是最后一集，禁用下一集按钮
            if (currentEpisodeIndex >= currentEpisodes.length - 1) {
                nextButton.disabled = true;
                nextButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                nextButton.disabled = false;
                nextButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // 渲染集数列表
        function renderEpisodes() {
            const episodesList = document.getElementById('episodesList');
            
            // 如果没有集数信息，显示提示
            if (!currentEpisodes || currentEpisodes.length === 0) {
                episodesList.innerHTML = '<div class="col-span-full text-center text-gray-400 py-8">没有可用的集数信息</div>';
                return;
            }
            
            // 清空列表
            episodesList.innerHTML = '';
            
            // 根据排序设置决定显示顺序
            let displayEpisodes = [...currentEpisodes];
            if (episodesReversed) {
                displayEpisodes.reverse();
            }
            
            // 为每一集创建按钮
            displayEpisodes.forEach((_, i) => {
                // 计算实际的集数索引（考虑排序）
                const actualIndex = episodesReversed ? (currentEpisodes.length - 1 - i) : i;
                
                // 创建集数按钮
                const episodeButton = document.createElement('button');
                episodeButton.className = 'px-3 py-2 bg-[#222] hover:bg-[#333] border border-[#333] rounded-lg transition-colors text-center';
                
                // 如果是当前播放的集数，添加高亮样式
                if (actualIndex === currentEpisodeIndex) {
                    episodeButton.classList.add('episode-active');
                }
                
                // 设置集数文本
                episodeButton.textContent = `${i + 1}`;
                
                // 添加点击事件
                episodeButton.addEventListener('click', () => {
                    playEpisode(actualIndex);
                });
                
                // 添加到列表
                episodesList.appendChild(episodeButton);
            });
        }

        // 播放指定集数
        function playEpisode(index) {
            // 检查索引是否有效
            if (index < 0 || index >= currentEpisodes.length) {
                console.error(`无效的剧集索引: ${index + 1}，当前剧集总数: ${currentEpisodes.length}`);
                showToast(`无效的剧集索引: ${index + 1}，当前剧集总数: ${currentEpisodes.length}`);
                return;
            }
            
            // 保存当前播放进度（如果正在播放）
            if (dp && dp.video && !dp.video.paused && !videoHasEnded) {
                saveCurrentProgress();
            }
            
            // 清除进度保存计时器
            if (progressSaveInterval) {
                clearInterval(progressSaveInterval);
                progressSaveInterval = null;
            }
            
            // 首先隐藏之前可能显示的错误
            document.getElementById('error').style.display = 'none';
            // 显示加载指示器
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading').innerHTML = `
                <div class="loading-spinner"></div>
                <div>正在加载视频...</div>
            `;
            
            const url = currentEpisodes[index];
            currentEpisodeIndex = index;
            videoHasEnded = false; // 重置视频结束标志
            
            // 获取当前URL参数，保留source参数
            const urlParams = new URLSearchParams(window.location.search);
            const sourceName = urlParams.get('source') || '';
            const sourceCode = urlParams.get('source_code') || '';
            
            // 更新URL，不刷新页面，保留source参数
            const newUrl = new URL(window.location.href);
            newUrl.searchParams.set('index', index);
            newUrl.searchParams.set('url', url);
            if (sourceName) {
                newUrl.searchParams.set('source', sourceName);
            }
            if (sourceCode) {
                newUrl.searchParams.set('source_code', sourceCode);
            }
            window.history.pushState({}, '', newUrl);
            
            // 更新播放器
            if (dp) {
                try {
                    dp.switchVideo({
                        url: url,
                        type: 'hls'
                    });
                    
                    // 确保播放开始
                    const playPromise = dp.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.warn('播放失败，尝试重新初始化:', error);
                            // 如果切换视频失败，重新初始化播放器
                            initPlayer(url, sourceCode);
                        });
                    }
                } catch (e) {
                    console.error('切换视频出错，尝试重新初始化:', e);
                    // 如果出错，重新初始化播放器
                    initPlayer(url, sourceCode);
                }
            } else {
                initPlayer(url, sourceCode);
            }
            
            // 更新UI
            updateEpisodeInfo();
            updateButtonStates();
            renderEpisodes();

            // 重置用户点击位置记录
            userClickedPosition = null;
            
            // 三秒后保存到历史记录
            setTimeout(() => saveToHistory(), 3000);
        }

        // 播放上一集
        function playPreviousEpisode() {
            if (currentEpisodeIndex > 0) {
                playEpisode(currentEpisodeIndex - 1);
            }
        }

        // 播放下一集
        function playNextEpisode() {
            if (currentEpisodeIndex < currentEpisodes.length - 1) {
                playEpisode(currentEpisodeIndex + 1);
            }
        }

        // 切换集数排序
        function toggleEpisodeOrder() {
            episodesReversed = !episodesReversed;
            
            // 保存到localStorage
            localStorage.setItem('episodesReversed', episodesReversed);
            
            // 重新渲染集数列表
            renderEpisodes();
            
            // 更新排序按钮
            updateOrderButton();
        }

        // 更新排序按钮状态
        function updateOrderButton() {
            const orderText = document.getElementById('orderText');
            const orderIcon = document.getElementById('orderIcon');
            
            if (orderText && orderIcon) {
                orderText.textContent = episodesReversed ? '正序排列' : '倒序排列';
                orderIcon.style.transform = episodesReversed ? 'rotate(180deg)' : '';
            }
        }

        // 设置进度条准确点击处理
        function setupProgressBarPreciseClicks() {
            // 查找DPlayer的进度条元素
            const progressBar = document.querySelector('.dplayer-bar-wrap');
            if (!progressBar || !dp || !dp.video) return;
            
            // 移除可能存在的旧事件监听器
            progressBar.removeEventListener('mousedown', handleProgressBarClick);
            
            // 添加新的事件监听器
            progressBar.addEventListener('mousedown', handleProgressBarClick);
            
            // 在移动端也添加触摸事件支持
            progressBar.removeEventListener('touchstart', handleProgressBarTouch);
            progressBar.addEventListener('touchstart', handleProgressBarTouch);
            
            console.log('进度条精确点击监听器已设置');
        }

        // 处理进度条点击
        function handleProgressBarClick(e) {
            if (!dp || !dp.video) return;
            
            // 计算点击位置相对于进度条的比例
            const rect = e.currentTarget.getBoundingClientRect();
            const percentage = (e.clientX - rect.left) / rect.width;
            
            // 计算点击位置对应的视频时间
            const duration = dp.video.duration;
            let clickTime = percentage * duration;
            
            // 处理视频接近结尾的情况
            if (duration - clickTime < 1) {
                // 如果点击位置非常接近结尾，稍微往前移一点
                clickTime = Math.min(clickTime, duration - 1.5);
                console.log(`进度条点击接近结尾，调整时间为 ${clickTime.toFixed(2)}/${duration.toFixed(2)}`);
            }
            
            // 记录用户点击的位置
            userClickedPosition = clickTime;
            
            // 输出调试信息
            console.log(`进度条点击: ${percentage.toFixed(4)}, 时间: ${clickTime.toFixed(2)}/${duration.toFixed(2)}`);
            
            // 阻止默认事件传播，避免DPlayer内部逻辑将视频跳至末尾
            e.stopPropagation();
            
            // 直接设置视频时间
            dp.seek(clickTime);
        }

        // 处理移动端触摸事件
        function handleProgressBarTouch(e) {
            if (!dp || !dp.video || !e.touches[0]) return;
            
            const touch = e.touches[0];
            const rect = e.currentTarget.getBoundingClientRect();
            const percentage = (touch.clientX - rect.left) / rect.width;
            
            const duration = dp.video.duration;
            let clickTime = percentage * duration;
            
            // 处理视频接近结尾的情况
            if (duration - clickTime < 1) {
                clickTime = Math.min(clickTime, duration - 1.5);
            }
            
            // 记录用户点击的位置
            userClickedPosition = clickTime;
            
            console.log(`进度条触摸: ${percentage.toFixed(4)}, 时间: ${clickTime.toFixed(2)}/${duration.toFixed(2)}`);
            
            e.stopPropagation();
            dp.seek(clickTime);
        }
        
        // 在播放器初始化后添加视频到历史记录
        function saveToHistory() {
            // 确保 currentEpisodes 非空
            if (!currentEpisodes || currentEpisodes.length === 0) {
                console.warn('没有可用的剧集列表，无法保存完整的历史记录');
            }
            
            // 尝试从URL中获取参数
            const urlParams = new URLSearchParams(window.location.search);
            const sourceName = urlParams.get('source') || '';
            const sourceCode = urlParams.get('source_code') || '';

            // 获取当前播放进度
            let currentPosition = 0;
            let videoDuration = 0;
            
            if (dp && dp.video) {
                currentPosition = dp.video.currentTime;
                videoDuration = dp.video.duration;
            }

            // 构建要保存的视频信息对象
            const videoInfo = {
                title: currentVideoTitle,
                // 创建基础URL，使用标题作为唯一标识符
                url: `player.html?title=${encodeURIComponent(currentVideoTitle)}&source=${encodeURIComponent(sourceName)}&source_code=${encodeURIComponent(sourceCode)}`,
                episodeIndex: currentEpisodeIndex,
                sourceName: sourceName,
                timestamp: Date.now(),
                // 添加播放进度信息
                playbackPosition: currentPosition > 10 ? currentPosition : 0,
                duration: videoDuration,
                // 重要：保存完整的集数列表，确保进行深拷贝
                episodes: currentEpisodes && currentEpisodes.length > 0 ? [...currentEpisodes] : []
            };
            
            // 如果外部定义了addToViewingHistory函数，则调用它
            if (typeof addToViewingHistory === 'function') {
                addToViewingHistory(videoInfo);
                console.log(`已保存 "${currentVideoTitle}" 的历史记录, 集数数据: ${currentEpisodes.length}集`);
            } else {
                // 否则直接使用本地实现
                try {
                    const history = JSON.parse(localStorage.getItem('viewingHistory') || '[]');
                    
                    // 检查是否已经存在相同标题的记录（同一视频的不同集数）
                    const existingIndex = history.findIndex(item => item.title === videoInfo.title);
                    if (existingIndex !== -1) {
                        // 存在则更新现有记录的集数、时间戳和URL
                        history[existingIndex].episodeIndex = currentEpisodeIndex;
                        history[existingIndex].timestamp = Date.now();
                        history[existingIndex].sourceName = sourceName
                        // 更新播放进度信息
                        history[existingIndex].playbackPosition = currentPosition > 10 ? currentPosition : history[existingIndex].playbackPosition;
                        history[existingIndex].duration = videoDuration || history[existingIndex].duration;
                        // 同时更新URL以保存当前的集数状态
                        history[existingIndex].url = window.location.href;
                        // 更新集数列表（如果有且与当前不同）
                        if (currentEpisodes && currentEpisodes.length > 0) {
                            // 检查是否需要更新集数数据（针对不同长度的集数列表）
                            if (!history[existingIndex].episodes || 
                                !Array.isArray(history[existingIndex].episodes) || 
                                history[existingIndex].episodes.length !== currentEpisodes.length) {
                                history[existingIndex].episodes = [...currentEpisodes]; // 深拷贝
                                console.log(`更新 "${currentVideoTitle}" 的剧集数据: ${currentEpisodes.length}集`);
                            }
                        }
                        
                        // 移到最前面
                        const updatedItem = history.splice(existingIndex, 1)[0];
                        history.unshift(updatedItem);
                    } else {
                        // 添加新记录到最前面，但保存完整URL以便能直接打开到正确的集数
                        videoInfo.url = window.location.href;
                        console.log(`创建新的历史记录: "${currentVideoTitle}", ${currentEpisodes.length}集`);
                        history.unshift(videoInfo);
                    }
                    
                    // 限制历史记录数量为50条
                    if (history.length > 50) history.splice(50);
                    
                    localStorage.setItem('viewingHistory', JSON.stringify(history));
                } catch (e) {
                    console.error('保存观看历史失败:', e);
                }
            }
        }

        // 显示恢复位置提示
        function showPositionRestoreHint(position) {
            if (!position || position < 10) return;
            
            // 创建提示元素
            const hint = document.createElement('div');
            hint.className = 'position-restore-hint';
            hint.innerHTML = `
                <div class="hint-content">
                    已从 ${formatTime(position)} 继续播放
                </div>
            `;
            
            // 添加到播放器容器
            const playerContainer = document.querySelector('.player-container');
            playerContainer.appendChild(hint);
            
            // 显示提示
            setTimeout(() => {
                hint.classList.add('show');
                
                // 3秒后隐藏
                setTimeout(() => {
                    hint.classList.remove('show');
                    setTimeout(() => hint.remove(), 300);
                }, 3000);
            }, 100);
        }
        
        // 格式化时间为 mm:ss 格式
        function formatTime(seconds) {
            if (isNaN(seconds)) return '00:00';
            
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        // 开始定期保存播放进度
        function startProgressSaveInterval() {
            // 清除可能存在的旧计时器
            if (progressSaveInterval) {
                clearInterval(progressSaveInterval);
            }
            
            // 每30秒保存一次播放进度
            progressSaveInterval = setInterval(saveCurrentProgress, 30000);
        }
        
        // 保存当前播放进度
        function saveCurrentProgress() {
            if (!dp || !dp.video) return;
            const currentTime = dp.video.currentTime;
            const duration = dp.video.duration;
            if (!duration || currentTime < 1) return;

            // 在localStorage中保存进度
            const progressKey = `videoProgress_${getVideoId()}`;
            const progressData = {
                position: currentTime,
                duration: duration,
                timestamp: Date.now()
            };
            try {
                localStorage.setItem(progressKey, JSON.stringify(progressData));
                // --- 新增：同步更新 viewingHistory 中的进度 ---
                try {
                    const historyRaw = localStorage.getItem('viewingHistory');
                    if (historyRaw) {
                        const history = JSON.parse(historyRaw);
                        // 用 title + 集数索引唯一标识
                        const idx = history.findIndex(item =>
                            item.title === currentVideoTitle &&
                            (item.episodeIndex === undefined || item.episodeIndex === currentEpisodeIndex)
                        );
                        if (idx !== -1) {
                            // 只在进度有明显变化时才更新，减少写入
                            if (
                                Math.abs((history[idx].playbackPosition || 0) - currentTime) > 2 ||
                                Math.abs((history[idx].duration || 0) - duration) > 2
                            ) {
                                history[idx].playbackPosition = currentTime;
                                history[idx].duration = duration;
                                history[idx].timestamp = Date.now();
                                localStorage.setItem('viewingHistory', JSON.stringify(history));
                            }
                        }
                    }
                } catch (e) {
                    // 忽略 viewingHistory 更新错误
                }
            } catch (e) {
                console.error('保存播放进度失败', e);
            }
        }

        // 设置移动端长按两倍速播放功能
        function setupLongPressSpeedControl() {
            if (!dp || !dp.video) return;
            
            const playerElement = document.getElementById('player');
            let longPressTimer = null;
            let originalPlaybackRate = 1.0;
            let isLongPress = false;
            
            // 显示快速提示
            function showSpeedHint(speed) {
                showShortcutHint(`${speed}倍速`, 'right');
            }

            // 禁用右键
            playerElement.oncontextmenu =  () => {
                // 检测是否为移动设备
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                // 只在移动设备上禁用右键
                if (isMobile) {
                    document.querySelector(".dplayer-menu").style.display = "none";
                    document.querySelector(".dplayer-menu-show").classList.remove("dplayer-menu-show");
                    return false;
                }
                return true;
            };
            
            // 触摸开始事件
            playerElement.addEventListener('touchstart', function(e) {
                // 保存原始播放速度
                originalPlaybackRate = dp.video.playbackRate;
                
                // 设置长按计时器
                longPressTimer = setTimeout(function() {
                    isLongPress = true;
                    // 设置为2倍速
                    dp.speed(2.0);
                    showSpeedHint(2.0);
                    
                    // 添加震动反馈（如果设备支持）
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                }, 500); // 500毫秒长按触发
            });
            
            // 触摸结束事件
            playerElement.addEventListener('touchend', function(e) {
                // 清除长按计时器
                clearTimeout(longPressTimer);
                
                // 如果是长按，恢复原始播放速度
                if (isLongPress) {
                    dp.speed(originalPlaybackRate);
                    showSpeedHint(originalPlaybackRate);
                    isLongPress = false;
                    
                    // 防止触发点击事件
                    e.preventDefault();
                }
            });
            
            // 触摸取消事件
            playerElement.addEventListener('touchcancel', function(e) {
                // 清除长按计时器
                clearTimeout(longPressTimer);
                
                // 如果是长按，恢复原始播放速度
                if (isLongPress) {
                    dp.speed(originalPlaybackRate);
                    showSpeedHint(originalPlaybackRate);
                    isLongPress = false;
                }
            });
            
            // 触摸移动事件（防止长按后拖动）
            playerElement.addEventListener('touchmove', function(e) {
                // 如果移动距离超过阈值，取消长按
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
                
                // 如果已经是长按状态，恢复原始播放速度
                if (isLongPress) {
                    dp.speed(originalPlaybackRate);
                    showSpeedHint(originalPlaybackRate);
                    isLongPress = false;
                }
            });
        }

        // 显示快捷键提示
        function showShortcutHint(text, direction = 'left') {
            const shortcutHint = document.getElementById('shortcutHint');
            const shortcutText = document.getElementById('shortcutText');
            const shortcutIcon = document.getElementById('shortcutIcon');
            
            // 设置文本
            shortcutText.textContent = text;
            
            // 设置图标
            if (direction === 'left') {
                shortcutIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>';
            } else if (direction === 'right') {
                shortcutIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>';
            } else if (direction === 'up') {
                shortcutIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>';
            } else if (direction === 'down') {
                shortcutIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>';
            } else if (direction === 'play') {
                shortcutIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
            } else if (direction === 'pause') {
                shortcutIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
            } else if (direction === 'volume') {
                shortcutIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>';
            } else if (direction === 'mute') {
                shortcutIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path>';
            }
            
            // 清除可能存在的旧计时器
            if (shortcutHintTimeout) {
                clearTimeout(shortcutHintTimeout);
            }
            
            // 显示提示
            shortcutHint.classList.add('show');
            
            // 设置自动隐藏计时器
            shortcutHintTimeout = setTimeout(function() {
                shortcutHint.classList.remove('show');
            }, 1000);
        }

        // 显示Toast提示
        function showToast(message, duration = 3000) {
            // 创建Toast元素
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-black/80 text-white px-4 py-2 rounded-lg z-50 transition-opacity duration-300 opacity-0';
            toast.textContent = message;
            
            // 添加到body
            document.body.appendChild(toast);
            
            // 显示Toast
            setTimeout(() => {
                toast.classList.remove('opacity-0');
                toast.classList.add('opacity-100');
                
                // 设置自动隐藏
                setTimeout(() => {
                    toast.classList.remove('opacity-100');
                    toast.classList.add('opacity-0');
                    
                    // 移除元素
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                }, duration);
            }, 10);
        }
        
        // 锁定/解锁控制
        function toggleControlsLock() {
            const lockIcon = document.getElementById('lockIcon');
            const isLocked = lockIcon.getAttribute('data-locked') === 'true';
            
            if (isLocked) {
                // 解锁控制
                lockIcon.setAttribute('data-locked', 'false');
                lockIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11V7a3 3 0 00-6 0v4m-3 4h12v6H6v-6z" />';
                
                // 启用按钮
                document.querySelectorAll('.player-container button:not(#lockToggle)').forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'pointer-events-none');
                });
                
                // 启用集数网格
                document.getElementById('episodesGrid').classList.remove('pointer-events-none', 'opacity-50');
                
                // 显示提示
                showToast('已解锁控制', 1500);
            } else {
                // 锁定控制
                lockIcon.setAttribute('data-locked', 'true');
                lockIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />';
                
                // 禁用按钮（除了锁定按钮自身）
                document.querySelectorAll('.player-container button:not(#lockToggle)').forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'pointer-events-none');
                });
                
                // 禁用集数网格
                document.getElementById('episodesGrid').classList.add('pointer-events-none', 'opacity-50');
                
                // 显示提示
                showToast('已锁定控制', 1500);
            }
        }
    </script>
</body>
</html>
